# USAGE EXAMPLE: env owner=obsidiansystems repo=rhyolite rev=refs/heads/develop <this-file>
# USAGE EXAMPLE: env owner=obsidiansystems repo=rhyolite <this-file>

export branch=`basename $rev || echo ""`
# echo $branch
uribase=/r-cache/git
uri=$uribase/github.com/$owner/$repo
git --git-dir $uri fetch --all
# echo $cached
nix-prefetch-git $uri --rev $rev \
  | jq '{ owner:"$owner", repo:"$repo", branch:"$branch", rev, sha256 }' \
  | shab \
  | jq 'with_entries(select(.value != ""))' -r

# ###
# OUT
# jq '{ url: "https://github.com/$(echo $owner/$repo)", owner: "$owner", repo: "$repo", branch: "$branch", rev, sha256 }' \

# Filtering null values: https://github.com/stedolan/jq/wiki/FAQ
# jq 'walk(if type == "object" then with_entries(select(.value != null)) else . end)' -r
